{"version":3,"file":"exchange.js","sourceRoot":"","sources":["../../../src/entities/exchange.ts"],"names":[],"mappings":"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","sourcesContent":["import type { TokenInfo } from \"@saberhq/token-utils\";\nimport {\n  deserializeAccount,\n  deserializeMint,\n  parseBigintIsh,\n  Token,\n  TokenAmount,\n} from \"@saberhq/token-utils\";\nimport type { Connection, PublicKey } from \"@solana/web3.js\";\nimport BN from \"bn.js\";\nimport type { default as JSBI } from \"jsbi\";\nimport { default as invariant } from \"tiny-invariant\";\n\nimport { SWAP_PROGRAM_ID } from \"../constants.js\";\nimport { StableSwap } from \"../stable-swap.js\";\nimport type { Fees } from \"../state/fees.js\";\nimport type { StableSwapState } from \"../state/index.js\";\nimport { loadProgramAccount } from \"../util/account.js\";\n\n/**\n * Reserve information.\n */\nexport interface IReserve {\n  /**\n   * Swap account holding the reserve tokens\n   */\n  reserveAccount: PublicKey;\n  /**\n   * Destination account of admin fees of this reserve token\n   */\n  adminFeeAccount: PublicKey;\n  /**\n   * Amount of tokens in the reserve\n   */\n  amount: TokenAmount;\n}\n\n/**\n * Static definition of an exchange.\n */\nexport interface IExchange {\n  programID: PublicKey;\n  swapAccount: PublicKey;\n  lpToken: Token;\n  tokens: readonly [Token, Token];\n}\n\n/**\n * Info loaded from the exchange. This is used by the calculator.\n */\nexport interface IExchangeInfo {\n  ampFactor: JSBI;\n  fees: Fees;\n  lpTotalSupply: TokenAmount;\n  reserves: readonly [IReserve, IReserve];\n}\n\n/**\n * Calculates the amp factor of a swap.\n * @param state\n * @param now\n * @returns\n */\nexport const calculateAmpFactor = (\n  state: Pick<\n    StableSwapState,\n    | \"initialAmpFactor\"\n    | \"targetAmpFactor\"\n    | \"startRampTimestamp\"\n    | \"stopRampTimestamp\"\n  >,\n  now = Date.now() / 1_000\n): JSBI => {\n  const {\n    initialAmpFactor,\n    targetAmpFactor,\n    startRampTimestamp,\n    stopRampTimestamp,\n  } = state;\n\n  // The most common case is that there is no ramp in progress.\n  if (now >= stopRampTimestamp) {\n    return parseBigintIsh(targetAmpFactor);\n  }\n\n  // If the ramp is about to start, use the initial amp.\n  if (now <= startRampTimestamp) {\n    return parseBigintIsh(initialAmpFactor);\n  }\n\n  invariant(\n    stopRampTimestamp >= startRampTimestamp,\n    \"stop must be after start\"\n  );\n  // Calculate how far we are along the ramp curve.\n  const percent =\n    now >= stopRampTimestamp\n      ? 1\n      : now <= startRampTimestamp\n      ? 0\n      : (now - startRampTimestamp) / (stopRampTimestamp - startRampTimestamp);\n  const diff = Math.floor(\n    parseFloat(targetAmpFactor.sub(initialAmpFactor).toString()) * percent\n  );\n  return parseBigintIsh(initialAmpFactor.add(new BN(diff)));\n};\n\n/**\n * Creates an IExchangeInfo from parameters.\n * @returns\n */\nexport const makeExchangeInfo = ({\n  exchange,\n  swap,\n  accounts,\n}: {\n  exchange: IExchange;\n  swap: StableSwap;\n  accounts: {\n    reserveA: Buffer;\n    reserveB: Buffer;\n    poolMint?: Buffer;\n  };\n}): IExchangeInfo => {\n  const swapAmountA = deserializeAccount(accounts.reserveA).amount;\n  const swapAmountB = deserializeAccount(accounts.reserveB).amount;\n\n  const poolMintSupply = accounts.poolMint\n    ? deserializeMint(accounts.poolMint).supply\n    : undefined;\n\n  const ampFactor = calculateAmpFactor(swap.state);\n\n  return {\n    ampFactor,\n    fees: swap.state.fees,\n    lpTotalSupply: new TokenAmount(exchange.lpToken, poolMintSupply ?? 0),\n    reserves: [\n      {\n        reserveAccount: swap.state.tokenA.reserve,\n        adminFeeAccount: swap.state.tokenA.adminFeeAccount,\n        amount: new TokenAmount(exchange.tokens[0], swapAmountA),\n      },\n      {\n        reserveAccount: swap.state.tokenB.reserve,\n        adminFeeAccount: swap.state.tokenB.adminFeeAccount,\n        amount: new TokenAmount(exchange.tokens[1], swapAmountB),\n      },\n    ],\n  };\n};\n\n/**\n * Loads exchange info.\n * @param exchange\n * @param swap\n * @returns\n */\nexport const loadExchangeInfo = async (\n  connection: Connection,\n  exchange: IExchange,\n  swap: StableSwap\n): Promise<IExchangeInfo> => {\n  if (!exchange.programID.equals(swap.config.swapProgramID)) {\n    throw new Error(\"Swap program id mismatch\");\n  }\n\n  const reserveA = await loadProgramAccount(\n    connection,\n    swap.state.tokenA.reserve,\n    swap.config.tokenProgramID\n  );\n  const reserveB = await loadProgramAccount(\n    connection,\n    swap.state.tokenB.reserve,\n    swap.config.tokenProgramID\n  );\n  const poolMint = await loadProgramAccount(\n    connection,\n    swap.state.poolTokenMint,\n    swap.config.tokenProgramID\n  );\n  return makeExchangeInfo({\n    swap,\n    exchange,\n    accounts: {\n      reserveA,\n      reserveB,\n      poolMint,\n    },\n  });\n};\n\n/**\n * Simplified representation of an IExchange. Useful for configuration.\n */\nexport interface ExchangeBasic {\n  /**\n   * Swap account.\n   */\n  swapAccount: PublicKey;\n  /**\n   * Mint of the LP token.\n   */\n  lpToken: PublicKey;\n  /**\n   * Info of token A.\n   */\n  tokenA: TokenInfo;\n  /**\n   * Info of token B.\n   */\n  tokenB: TokenInfo;\n}\n\n/**\n * Creates an IExchange from an ExchangeBasic.\n * @param tokenMap\n * @param param1\n * @returns\n */\nexport const makeExchange = ({\n  swapAccount,\n  lpToken,\n  tokenA,\n  tokenB,\n}: ExchangeBasic): IExchange | null => {\n  const exchange: IExchange = {\n    swapAccount,\n    programID: SWAP_PROGRAM_ID,\n    lpToken: new Token({\n      symbol: \"SLP\",\n      name: `${tokenA.symbol}-${tokenB.symbol} Saber LP`,\n      logoURI: \"https://app.saber.so/tokens/slp.png\",\n      decimals: tokenA.decimals,\n      address: lpToken.toString(),\n      chainId: tokenA.chainId,\n      tags: [\"saber-stableswap-lp\"],\n    }),\n    tokens: [new Token(tokenA), new Token(tokenB)],\n  };\n  return exchange;\n};\n\n/**\n * Get exchange info from just the swap account.\n * @param connection\n * @param swapAccount\n * @param tokenA\n * @param tokenB\n * @returns\n */\nexport const loadExchangeInfoFromSwapAccount = async (\n  connection: Connection,\n  swapAccount: PublicKey,\n  tokenA: Token | undefined = undefined,\n  tokenB: Token | undefined = undefined\n): Promise<IExchangeInfo | null> => {\n  const stableSwap = await StableSwap.load(connection, swapAccount);\n\n  const theTokenA =\n    tokenA ??\n    (await Token.load(connection, stableSwap.state.tokenA.mint))?.info;\n  if (!theTokenA) {\n    throw new Error(\n      `Token ${stableSwap.state.tokenA.mint.toString()} not found`\n    );\n  }\n\n  const theTokenB =\n    tokenB ??\n    (await Token.load(connection, stableSwap.state.tokenB.mint))?.info;\n  if (!theTokenB) {\n    throw new Error(\n      `Token ${stableSwap.state.tokenB.mint.toString()} not found`\n    );\n  }\n\n  const exchange = makeExchange({\n    swapAccount,\n    lpToken: stableSwap.state.poolTokenMint,\n    tokenA: theTokenA,\n    tokenB: theTokenB,\n  });\n\n  if (exchange === null) {\n    return null;\n  }\n\n  return await loadExchangeInfo(connection, exchange, stableSwap);\n};\n"]}