import { __awaiter } from "tslib";
import { TransactionEnvelope } from "@saberhq/solana-contrib";
import { SystemProgram } from "@solana/web3.js";
import { QuarrySDK } from "../../sdk";
import { findQuarryAddress } from "./pda";
import { QuarryWrapper } from "./quarry";
export class RewarderWrapper {
    constructor(mineWrapper, rewarderKey, rewarderData) {
        this.mineWrapper = mineWrapper;
        this.rewarderKey = rewarderKey;
        this.rewarderData = rewarderData;
        this.sdk = mineWrapper.sdk;
        this.program = mineWrapper.program;
    }
    get provider() {
        return this.sdk.provider;
    }
    static fromData(provider, rewarder) {
        return new RewarderWrapper(QuarrySDK.load({ provider }).mine, rewarder.publicKey, rewarder.account);
    }
    /**
     * Gets the quarry associated with the given token.
     * @param token
     * @returns
     */
    getQuarry(token) {
        return __awaiter(this, void 0, void 0, function* () {
            const quarryKey = yield this.getQuarryKey(token);
            return yield QuarryWrapper.load({
                sdk: this.sdk,
                token,
                key: quarryKey,
            });
        });
    }
    /**
     * Gets the public key of a quarry for a token.
     * @param token
     * @returns
     */
    getQuarryKey(token) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.getQuarryKeyForMint(token.mintAccount);
        });
    }
    /**
     * Gets the public key of a quarry for a token mint.
     * @param token
     * @returns
     */
    getQuarryKeyForMint(mint) {
        return __awaiter(this, void 0, void 0, function* () {
            const [quarryKey] = yield findQuarryAddress(this.rewarderKey, mint, this.program.programId);
            return quarryKey;
        });
    }
    /**
     * Creates a new quarry. Only the rewarder can call this.
     * @deprecated Use {@link createQuarry}.
     * @param param0
     * @returns
     */
    createQuarryV1({ token, authority = this.provider.wallet.publicKey, }) {
        return __awaiter(this, void 0, void 0, function* () {
            const [quarryKey, bump] = yield findQuarryAddress(this.rewarderKey, token.mintAccount, this.program.programId);
            const ix = this.program.instruction.createQuarry(bump, {
                accounts: {
                    quarry: quarryKey,
                    auth: {
                        authority,
                        rewarder: this.rewarderKey,
                    },
                    tokenMint: token.mintAccount,
                    payer: this.provider.wallet.publicKey,
                    systemProgram: SystemProgram.programId,
                    unusedAccount: SystemProgram.programId,
                },
            });
            return {
                rewarder: this.rewarderKey,
                quarry: quarryKey,
                tx: this.sdk.newTx([ix]),
            };
        });
    }
    /**
     * Creates a new quarry. Only the rewarder can call this.
     * @param param0
     * @returns
     */
    createQuarry({ token, authority = this.provider.wallet.publicKey, }) {
        return __awaiter(this, void 0, void 0, function* () {
            const [quarryKey] = yield findQuarryAddress(this.rewarderKey, token.mintAccount, this.program.programId);
            const ix = this.program.instruction.createQuarryV2({
                accounts: {
                    quarry: quarryKey,
                    auth: {
                        authority,
                        rewarder: this.rewarderKey,
                    },
                    tokenMint: token.mintAccount,
                    payer: this.provider.wallet.publicKey,
                    systemProgram: SystemProgram.programId,
                },
            });
            return {
                rewarder: this.rewarderKey,
                quarry: quarryKey,
                tx: this.sdk.newTx([ix]),
            };
        });
    }
    /**
     * Updates annual rewards rate on the Rewarder.
     * One must sync after this.
     * @param param0
     */
    setAnnualRewards({ newAnnualRate, authority = this.provider.wallet.publicKey, }) {
        return new TransactionEnvelope(this.sdk.provider, [
            this.program.instruction.setAnnualRewards(newAnnualRate, {
                accounts: {
                    auth: {
                        rewarder: this.rewarderKey,
                        authority,
                    },
                },
            }),
        ]);
    }
    /**
     * Updates to annual rewards rate on the quarry, and update rewards on quarries assocated with each mint provided.
     * @param param0
     */
    setAndSyncAnnualRewards(newAnnualRate, mints) {
        return __awaiter(this, void 0, void 0, function* () {
            const tx = yield this.syncQuarryRewards(mints);
            return this.setAnnualRewards({ newAnnualRate }).combine(tx);
        });
    }
    /**
     * Synchronizes quarry rewards.
     * @param mints
     * @returns
     */
    syncQuarryRewards(mints) {
        return __awaiter(this, void 0, void 0, function* () {
            const instructions = [];
            yield Promise.all(mints.map((m) => __awaiter(this, void 0, void 0, function* () {
                const quarry = yield this.getQuarryKeyForMint(m);
                instructions.push(this.program.instruction.updateQuarryRewards({
                    accounts: {
                        rewarder: this.rewarderKey,
                        quarry,
                    },
                }));
            })));
            return this.sdk.newTx(instructions);
        });
    }
    /**
     * Transfers the authority to a different account.
     * @param param0
     */
    transferAuthority({ authority = this.sdk.provider.wallet.publicKey, nextAuthority, }) {
        return new TransactionEnvelope(this.sdk.provider, [
            this.program.instruction.transferAuthority(nextAuthority, {
                accounts: {
                    authority,
                    rewarder: this.rewarderKey,
                },
            }),
        ]);
    }
    /**
     * Sets timestamp on when rewards will cease
     */
    setFamine({ newFamineTs, quarry, authority = this.sdk.provider.wallet.publicKey, }) {
        return new TransactionEnvelope(this.sdk.provider, [
            this.program.instruction.setFamine(newFamineTs, {
                accounts: {
                    auth: {
                        authority,
                        rewarder: this.rewarderKey,
                    },
                    quarry,
                },
            }),
        ]);
    }
    /**
     * Pause the rewarder
     */
    pause(authority = this.sdk.provider.wallet.publicKey) {
        return new TransactionEnvelope(this.sdk.provider, [
            this.program.instruction.pause({
                accounts: { pauseAuthority: authority, rewarder: this.rewarderKey },
            }),
        ]);
    }
    /**
     * Unpause the rewarder
     */
    unpause(authority = this.sdk.provider.wallet.publicKey) {
        return new TransactionEnvelope(this.sdk.provider, [
            this.program.instruction.unpause({
                accounts: { pauseAuthority: authority, rewarder: this.rewarderKey },
            }),
        ]);
    }
}
//# sourceMappingURL=rewarder.js.map