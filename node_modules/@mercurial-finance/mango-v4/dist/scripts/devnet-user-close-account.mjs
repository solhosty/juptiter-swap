import {
  MangoClient
} from "../chunk-HVUWVEE5.mjs";
import "../chunk-PDNGNLHE.mjs";
import "../chunk-TSHDMTGJ.mjs";
import "../chunk-P2PWY3QH.mjs";
import {
  Serum3Side
} from "../chunk-TCNCMUFM.mjs";
import "../chunk-BYB3CFSH.mjs";
import "../chunk-36PUIGQD.mjs";
import {
  MANGO_V4_ID
} from "../chunk-5SDTDLZO.mjs";
import "../chunk-O3IXUKHU.mjs";
import "../chunk-62VGMIX5.mjs";
import "../chunk-34DSBDDD.mjs";
import "../chunk-FP7S2XO3.mjs";
import "../chunk-Z2RB6KEX.mjs";
import "../chunk-5VRACIDE.mjs";

// ts/client/src/scripts/devnet-user-close-account.ts
import { AnchorProvider, BN, Wallet } from "@project-serum/anchor";
import { Connection, Keypair } from "@solana/web3.js";
import fs from "fs";
var GROUP_NUM = Number(process.env.GROUP_NUM || 0);
async function main() {
  const options = AnchorProvider.defaultOptions();
  const connection = new Connection(
    "https://mango.devnet.rpcpool.com",
    options
  );
  const user = Keypair.fromSecretKey(
    Buffer.from(
      JSON.parse(fs.readFileSync(process.env.USER_KEYPAIR, "utf-8"))
    )
  );
  const userWallet = new Wallet(user);
  const userProvider = new AnchorProvider(connection, userWallet, options);
  const client = await MangoClient.connect(
    userProvider,
    "devnet",
    MANGO_V4_ID["devnet"],
    {
      idsSource: "get-program-accounts"
    }
  );
  console.log(`User ${userWallet.publicKey.toBase58()}`);
  try {
    const admin = Keypair.fromSecretKey(
      Buffer.from(
        JSON.parse(fs.readFileSync(process.env.ADMIN_KEYPAIR, "utf-8"))
      )
    );
    const group = await client.getGroupForCreator(admin.publicKey, GROUP_NUM);
    console.log(`Found group ${group.publicKey.toBase58()}`);
    const mangoAccount = (await client.getMangoAccountsForOwner(group, user.publicKey))[0];
    console.log(`...found mangoAccount ${mangoAccount.publicKey}`);
    console.log(mangoAccount.toString());
    for (const serum3Account of mangoAccount.serum3Active()) {
      let orders = await mangoAccount.loadSerum3OpenOrdersForMarket(
        client,
        group,
        group.serum3MarketsMapByMarketIndex.get(serum3Account.marketIndex)?.serumMarketExternal
      );
      for (const order of orders) {
        console.log(
          ` - Order orderId ${order.orderId}, ${order.side}, ${order.price}, ${order.size}`
        );
        console.log(` - Cancelling order with ${order.orderId}`);
        await client.serum3CancelOrder(
          group,
          mangoAccount,
          group.serum3MarketsMapByMarketIndex.get(serum3Account.marketIndex)?.serumMarketExternal,
          order.side === "buy" ? Serum3Side.bid : Serum3Side.ask,
          order.orderId
        );
      }
      await client.serum3SettleFunds(
        group,
        mangoAccount,
        group.serum3MarketsMapByMarketIndex.get(serum3Account.marketIndex)?.serumMarketExternal
      );
      await client.serum3CloseOpenOrders(
        group,
        mangoAccount,
        group.serum3MarketsMapByMarketIndex.get(serum3Account.marketIndex)?.serumMarketExternal
      );
    }
    await mangoAccount.reload(client);
    for (const token of mangoAccount.tokensActive()) {
      let native = token.balance(
        group.getFirstBankByTokenIndex(token.tokenIndex)
      );
      if (native.toNumber() < 1) {
        continue;
      }
      let nativeFlooredNumber = Math.floor(native.toNumber());
      console.log(
        `withdrawing token ${group.getFirstBankByTokenIndex(token.tokenIndex).name} native amount ${nativeFlooredNumber} `
      );
      await client.tokenWithdrawNative(
        group,
        mangoAccount,
        group.getFirstBankByTokenIndex(token.tokenIndex).mint,
        new BN(
          nativeFlooredNumber - 1
        ),
        false
      );
    }
    await mangoAccount.reload(client);
    console.log(`...mangoAccount ${mangoAccount.publicKey}`);
    console.log(mangoAccount.toString());
    console.log(`Close mango account...`);
    const res = await client.closeMangoAccount(group, mangoAccount);
  } catch (error) {
    console.log(error);
  }
  process.exit();
}
main();
//# sourceMappingURL=devnet-user-close-account.mjs.map