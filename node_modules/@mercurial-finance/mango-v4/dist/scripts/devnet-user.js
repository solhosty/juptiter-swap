"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; } async function _asyncOptionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = await fn(value); } else if (op === 'call' || op === 'optionalCall') { value = await fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }

var _chunkHFEILVW4js = require('../chunk-HFEILVW4.js');
require('../chunk-A355EMTI.js');
require('../chunk-74ANAXXV.js');


var _chunkC3X3GVS5js = require('../chunk-C3X3GVS5.js');
require('../chunk-UGHO4YHY.js');
require('../chunk-3ZYUOGD4.js');



var _chunkZYSI4CYOjs = require('../chunk-ZYSI4CYO.js');


var _chunkS6N5Y2X2js = require('../chunk-S6N5Y2X2.js');


var _chunk772SHZWXjs = require('../chunk-772SHZWX.js');
require('../chunk-S3PQ6OXS.js');
require('../chunk-WKB2GIFW.js');
require('../chunk-TBVE5N24.js');
require('../chunk-Y7A4QF6J.js');
require('../chunk-JC4IRQUL.js');

// ts/client/src/scripts/devnet-user.ts
var _anchor = require('@project-serum/anchor');
var _web3js = require('@solana/web3.js');
var _chai = require('chai');
var _fs = require('fs'); var _fs2 = _interopRequireDefault(_fs);
var DEVNET_MINTS = /* @__PURE__ */ new Map([
  ["USDC", "8FRFC6MoGGkMFQwngccyu69VnYbzykGeez7ignHVAFSN"],
  // use devnet usdc
  ["BTC", "3UNBZ6o52WTWwjac2kPUb4FyodhU1vFkRJheu1Sh2TvU"],
  ["SOL", "So11111111111111111111111111111111111111112"],
  ["ORCA", "orcarKHSqC5CDDsGbho8GKvwExejWHxTqGzXgcewB9L"],
  ["MNGO", "Bb9bsTQa1bGEtQ5KagGkvSHyuLqDWumFUcRqFusFNJWC"]
]);
var DEVNET_SERUM3_MARKETS = /* @__PURE__ */ new Map([
  ["BTC/USDC", new (0, _web3js.PublicKey)("DW83EpHFywBxCHmyARxwj3nzxJd7MUdSeznmrdzZKNZB")],
  ["SOL/USDC", new (0, _web3js.PublicKey)("5xWpt56U1NCuHoAEtpLeUrQcxDkEpNfScjfLFaRzLPgR")]
]);
var GROUP_NUM = Number(process.env.GROUP_NUM || 0);
async function main() {
  const options = _anchor.AnchorProvider.defaultOptions();
  const connection = new (0, _web3js.Connection)(
    "https://mango.devnet.rpcpool.com",
    options
  );
  const user = _web3js.Keypair.fromSecretKey(
    Buffer.from(
      JSON.parse(_fs2.default.readFileSync(process.env.USER_KEYPAIR, "utf-8"))
    )
  );
  const userWallet = new (0, _anchor.Wallet)(user);
  const userProvider = new (0, _anchor.AnchorProvider)(connection, userWallet, options);
  const client = await _chunkHFEILVW4js.MangoClient.connect(
    userProvider,
    "devnet",
    _chunkS6N5Y2X2js.MANGO_V4_ID["devnet"],
    {
      idsSource: "get-program-accounts"
    }
  );
  console.log(`User ${userWallet.publicKey.toBase58()}`);
  const admin = _web3js.Keypair.fromSecretKey(
    Buffer.from(
      JSON.parse(_fs2.default.readFileSync(process.env.ADMIN_KEYPAIR, "utf-8"))
    )
  );
  const group = await client.getGroupForCreator(admin.publicKey, GROUP_NUM);
  console.log(`Creating mangoaccount...`);
  let mangoAccount = await client.getOrCreateMangoAccount(group);
  await mangoAccount.reload(client);
  if (!mangoAccount) {
    throw new Error(`MangoAccount not found for user ${user.publicKey}`);
  }
  console.log(`...created/found mangoAccount ${mangoAccount.publicKey}`);
  if (true) {
    console.log(`...changing mango account name, and setting a delegate`);
    const newName = "my_changed_name";
    const randomKey = new (0, _web3js.PublicKey)(
      "4ZkS7ZZkxfsC3GtvvsHP3DFcUeByU9zzZELS4r8HCELo"
    );
    await client.editMangoAccount(group, mangoAccount, newName, randomKey);
    await mangoAccount.reload(client);
    _chai.expect.call(void 0, mangoAccount.name).deep.equals(newName);
    _chai.expect.call(void 0, mangoAccount.delegate).deep.equals(randomKey);
    const oldName = "my_mango_account";
    console.log(`...resetting mango account name, and re-setting a delegate`);
    await client.editMangoAccount(
      group,
      mangoAccount,
      oldName,
      _web3js.PublicKey.default
    );
    await mangoAccount.reload(client);
    _chai.expect.call(void 0, mangoAccount.name).deep.equals(oldName);
    _chai.expect.call(void 0, mangoAccount.delegate).deep.equals(_web3js.PublicKey.default);
  }
  if (mangoAccount.tokens.length < 16 || mangoAccount.serum3.length < 8 || mangoAccount.perps.length < 8 || mangoAccount.perpOpenOrders.length < 8) {
    console.log(
      `...expanding mango account to max 16 token positions, 8 serum3, 8 perp position and 8 perp oo slots, previous (tokens ${mangoAccount.tokens.length}, serum3 ${mangoAccount.serum3.length}, perps ${mangoAccount.perps.length}, perps oo ${mangoAccount.perpOpenOrders.length})`
    );
    let sig = await client.expandMangoAccount(group, mangoAccount, 16, 8, 8, 8);
    console.log(`sig https://explorer.solana.com/tx/${sig}?cluster=devnet`);
    await mangoAccount.reload(client);
    _chai.expect.call(void 0, mangoAccount.tokens.length).equals(16);
    _chai.expect.call(void 0, mangoAccount.serum3.length).equals(8);
    _chai.expect.call(void 0, mangoAccount.perps.length).equals(8);
    _chai.expect.call(void 0, mangoAccount.perpOpenOrders.length).equals(8);
  }
  if (true) {
    console.log(`...depositing 50 USDC, 1 SOL, 1 MNGO`);
    let oldBalance = mangoAccount.getTokenBalance(
      group.getFirstBankByMint(new (0, _web3js.PublicKey)(DEVNET_MINTS.get("USDC")))
    );
    await client.tokenDeposit(
      group,
      mangoAccount,
      new (0, _web3js.PublicKey)(DEVNET_MINTS.get("USDC")),
      50
    );
    await mangoAccount.reload(client);
    let newBalance = mangoAccount.getTokenBalance(
      group.getFirstBankByMint(new (0, _web3js.PublicKey)(DEVNET_MINTS.get("USDC")))
    );
    _chai.expect.call(void 0, _chunk772SHZWXjs.toUiDecimalsForQuote.call(void 0, newBalance.sub(oldBalance)).toString()).equals(
      "50"
    );
    await client.tokenDeposit(
      group,
      mangoAccount,
      new (0, _web3js.PublicKey)(DEVNET_MINTS.get("SOL")),
      1
    );
    await mangoAccount.reload(client);
    await client.tokenDeposit(
      group,
      mangoAccount,
      new (0, _web3js.PublicKey)(DEVNET_MINTS.get("MNGO")),
      1
    );
    await mangoAccount.reload(client);
    console.log(`...withdrawing 1 USDC`);
    oldBalance = mangoAccount.getTokenBalance(
      group.getFirstBankByMint(new (0, _web3js.PublicKey)(DEVNET_MINTS.get("USDC")))
    );
    await client.tokenWithdraw(
      group,
      mangoAccount,
      new (0, _web3js.PublicKey)(DEVNET_MINTS.get("USDC")),
      1,
      true
    );
    await mangoAccount.reload(client);
    newBalance = mangoAccount.getTokenBalance(
      group.getFirstBankByMint(new (0, _web3js.PublicKey)(DEVNET_MINTS.get("USDC")))
    );
    _chai.expect.call(void 0, _chunk772SHZWXjs.toUiDecimalsForQuote.call(void 0, oldBalance.sub(newBalance)).toString()).equals(
      "1"
    );
    console.log(`...depositing 0.0005 BTC`);
    await client.tokenDeposit(
      group,
      mangoAccount,
      new (0, _web3js.PublicKey)(DEVNET_MINTS.get("BTC")),
      5e-4
    );
    await mangoAccount.reload(client);
  }
  if (true) {
    await mangoAccount.reload(client);
    console.log(
      "...mangoAccount.getEquity() " + _chunk772SHZWXjs.toUiDecimalsForQuote.call(void 0, mangoAccount.getEquity(group).toNumber())
    );
    console.log(
      "...mangoAccount.getCollateralValue() " + _chunk772SHZWXjs.toUiDecimalsForQuote.call(void 0, 
        mangoAccount.getCollateralValue(group).toNumber()
      )
    );
    console.log(
      "...mangoAccount.getAssetsVal() " + _chunk772SHZWXjs.toUiDecimalsForQuote.call(void 0, 
        mangoAccount.getAssetsValue(group, _chunkC3X3GVS5js.HealthType.init).toNumber()
      )
    );
    console.log(
      "...mangoAccount.getLiabsVal() " + _chunk772SHZWXjs.toUiDecimalsForQuote.call(void 0, 
        mangoAccount.getLiabsValue(group, _chunkC3X3GVS5js.HealthType.init).toNumber()
      )
    );
    console.log(
      '...mangoAccount.getMaxWithdrawWithBorrowForToken(group, "SOL") ' + _chunk772SHZWXjs.toUiDecimalsForQuote.call(void 0, 
        mangoAccount.getMaxWithdrawWithBorrowForToken(
          group,
          new (0, _web3js.PublicKey)(DEVNET_MINTS.get("SOL"))
        ).toNumber()
      )
    );
  }
  if (true) {
    let getMaxSourceForTokenSwapWrapper = function(src, tgt) {
      console.log(
        `getMaxSourceForTokenSwap ${src.padEnd(4)} ${tgt.padEnd(4)} ` + mangoAccount.getMaxSourceUiForTokenSwap(
          group,
          group.banksMapByName.get(src)[0].mint,
          group.banksMapByName.get(tgt)[0].mint,
          1
        )
      );
    };
    for (const srcToken of Array.from(group.banksMapByName.keys())) {
      for (const tgtToken of Array.from(group.banksMapByName.keys())) {
        getMaxSourceForTokenSwapWrapper(srcToken, tgtToken);
      }
    }
    const maxQuoteForSerum3BidUi = mangoAccount.getMaxQuoteForSerum3BidUi(
      group,
      DEVNET_SERUM3_MARKETS.get("BTC/USDC")
    );
    console.log(
      "...mangoAccount.getMaxQuoteForSerum3BidUi(group, 'BTC/USDC') " + maxQuoteForSerum3BidUi
    );
    const maxBaseForSerum3AskUi = mangoAccount.getMaxBaseForSerum3AskUi(
      group,
      DEVNET_SERUM3_MARKETS.get("BTC/USDC")
    );
    console.log(
      "...mangoAccount.getMaxBaseForSerum3AskUi(group, 'BTC/USDC') " + maxBaseForSerum3AskUi
    );
    console.log(
      `simHealthRatioWithSerum3BidUiChanges ${mangoAccount.simHealthRatioWithSerum3BidUiChanges(
        group,
        785,
        DEVNET_SERUM3_MARKETS.get("BTC/USDC")
      )}`
    );
    console.log(
      `simHealthRatioWithSerum3AskUiChanges ${mangoAccount.simHealthRatioWithSerum3AskUiChanges(
        group,
        0.033,
        DEVNET_SERUM3_MARKETS.get("BTC/USDC")
      )}`
    );
  }
  if (true) {
    let sig;
    let perpMarket = group.getPerpMarketByName("BTC-PERP");
    const orders = await mangoAccount.loadPerpOpenOrdersForMarket(
      client,
      group,
      perpMarket.perpMarketIndex
    );
    for (const order of orders) {
      console.log(
        `Current order - ${order.uiPrice} ${order.uiSize} ${order.side}`
      );
    }
    console.log(`...cancelling all perp orders`);
    sig = await client.perpCancelAllOrders(
      group,
      mangoAccount,
      perpMarket.perpMarketIndex,
      10
    );
    console.log(`sig https://explorer.solana.com/tx/${sig}?cluster=devnet`);
    try {
      const clientId = Math.floor(Math.random() * 99999);
      const price = group.banksMapByName.get("BTC")[0].uiPrice;
      console.log(
        `...placing perp pegged bid ${clientId} at oracle price ${perpMarket.uiPrice}`
      );
      const sig2 = await client.perpPlaceOrderPegged(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.bid,
        -5,
        perpMarket.uiPrice + 5,
        0.01,
        price * 0.011,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
    }
    try {
      const clientId = Math.floor(Math.random() * 99999);
      const price = group.banksMapByName.get("BTC")[0].uiPrice;
      console.log(
        `...placing perp pegged bid ${clientId} at oracle price ${perpMarket.uiPrice}`
      );
      const sig2 = await client.perpPlaceOrderPegged(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.ask,
        5,
        perpMarket.uiPrice - 5,
        0.01,
        price * 0.011,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
    }
    await logBidsAndAsks(client, group);
    sig = await client.perpCancelAllOrders(
      group,
      mangoAccount,
      perpMarket.perpMarketIndex,
      10
    );
    console.log(`sig https://explorer.solana.com/tx/${sig}?cluster=devnet`);
    try {
      const clientId = Math.floor(Math.random() * 99999);
      await mangoAccount.reload(client);
      await group.reloadAll(client);
      const price = group.banksMapByName.get("BTC")[0].uiPrice - Math.floor(Math.random() * 100);
      const quoteQty = mangoAccount.getMaxQuoteForPerpBidUi(
        group,
        perpMarket.perpMarketIndex
      );
      const baseQty = quoteQty / price;
      console.log(
        ` simHealthRatioWithPerpBidUiChanges - ${mangoAccount.simHealthRatioWithPerpBidUiChanges(
          group,
          perpMarket.perpMarketIndex,
          baseQty
        )}`
      );
      console.log(
        `...placing max qty perp bid  clientId ${clientId} at price ${price}, base ${baseQty}, quote ${quoteQty}`
      );
      const sig2 = await client.perpPlaceOrder(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.bid,
        price,
        baseQty,
        quoteQty,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        //Date.now() + 200,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
    }
    console.log(`...cancelling all perp orders`);
    sig = await client.perpCancelAllOrders(
      group,
      mangoAccount,
      perpMarket.perpMarketIndex,
      10
    );
    console.log(`sig https://explorer.solana.com/tx/${sig}?cluster=devnet`);
    try {
      const clientId = Math.floor(Math.random() * 99999);
      const price = group.banksMapByName.get("BTC")[0].uiPrice - Math.floor(Math.random() * 100);
      const quoteQty = mangoAccount.getMaxQuoteForPerpBidUi(
        group,
        perpMarket.perpMarketIndex
      ) * 1.02;
      const baseQty = quoteQty / price;
      console.log(
        `...placing max qty * 1.02 perp bid clientId ${clientId} at price ${price}, base ${baseQty}, quote ${quoteQty}`
      );
      const sig2 = await client.perpPlaceOrder(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.bid,
        price,
        baseQty,
        quoteQty,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        //Date.now() + 200,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
      console.log("Errored out as expected");
    }
    try {
      const clientId = Math.floor(Math.random() * 99999);
      const price = group.banksMapByName.get("BTC")[0].uiPrice + Math.floor(Math.random() * 100);
      const baseQty = mangoAccount.getMaxBaseForPerpAskUi(
        group,
        perpMarket.perpMarketIndex
      );
      console.log(
        ` simHealthRatioWithPerpAskUiChanges - ${mangoAccount.simHealthRatioWithPerpAskUiChanges(
          group,
          perpMarket.perpMarketIndex,
          baseQty
        )}`
      );
      const quoteQty = baseQty * price;
      console.log(
        `...placing max qty perp ask clientId ${clientId} at price ${price}, base ${baseQty}, quote ${quoteQty}`
      );
      const sig2 = await client.perpPlaceOrder(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.ask,
        price,
        baseQty,
        quoteQty,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        //Date.now() + 200,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
    }
    try {
      const clientId = Math.floor(Math.random() * 99999);
      const price = group.banksMapByName.get("BTC")[0].uiPrice + Math.floor(Math.random() * 100);
      const baseQty = mangoAccount.getMaxBaseForPerpAskUi(group, perpMarket.perpMarketIndex) * 1.02;
      const quoteQty = baseQty * price;
      console.log(
        `...placing max qty perp ask * 1.02 clientId ${clientId} at price ${price}, base ${baseQty}, quote ${quoteQty}`
      );
      const sig2 = await client.perpPlaceOrder(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.ask,
        price,
        baseQty,
        quoteQty,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        //Date.now() + 200,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
      console.log("Errored out as expected");
    }
    console.log(`...cancelling all perp orders`);
    sig = await client.perpCancelAllOrders(
      group,
      mangoAccount,
      perpMarket.perpMarketIndex,
      10
    );
    console.log(`sig https://explorer.solana.com/tx/${sig}?cluster=devnet`);
    try {
      const clientId = Math.floor(Math.random() * 99999);
      const price = group.banksMapByName.get("BTC")[0].uiPrice;
      console.log(`...placing perp bid ${clientId} at ${price}`);
      const sig2 = await client.perpPlaceOrder(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.bid,
        price,
        0.01,
        price * 0.01,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        //Date.now() + 200,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
    }
    try {
      const clientId = Math.floor(Math.random() * 99999);
      const price = group.banksMapByName.get("BTC")[0].uiPrice;
      console.log(`...placing perp ask ${clientId} at ${price}`);
      const sig2 = await client.perpPlaceOrder(
        group,
        mangoAccount,
        perpMarket.perpMarketIndex,
        _chunkZYSI4CYOjs.PerpOrderSide.ask,
        price,
        0.01,
        price * 0.011,
        clientId,
        _chunkZYSI4CYOjs.PerpOrderType.limit,
        false,
        0,
        //Date.now() + 200,
        1
      );
      console.log(`sig https://explorer.solana.com/tx/${sig2}?cluster=devnet`);
    } catch (error) {
      console.log(error);
    }
    await _optionalChain([perpMarket, 'optionalAccess', _ => _.loadEventQueue, 'call', _2 => _2(client)]);
    const fr = await _asyncOptionalChain([perpMarket, 'optionalAccess', async _3 => _3.getCurrentFundingRate, 'call', async _4 => _4(
      await perpMarket.loadBids(client),
      await perpMarket.loadAsks(client)
    )]);
    console.log(`current funding rate per hour is ${fr}`);
    const eq = await _optionalChain([perpMarket, 'optionalAccess', _5 => _5.loadEventQueue, 'call', _6 => _6(client)]);
    console.log(
      `raw events - ${JSON.stringify(eq.eventsSince(new (0, _anchor.BN)(0)), null, 2)}`
    );
    await new Promise((r) => setTimeout(r, 2e3));
    await group.reloadAll(client);
    await mangoAccount.reload(client);
    console.log(`${mangoAccount.toString(group)}`);
  }
  process.exit();
}
async function logBidsAndAsks(client, group) {
  await group.reloadAll(client);
  const perpMarket = group.getPerpMarketByName("BTC-PERP");
  const res = [
    (await _optionalChain([perpMarket, 'optionalAccess', _7 => _7.loadBids, 'call', _8 => _8(client)])).items(),
    (await _optionalChain([perpMarket, 'optionalAccess', _9 => _9.loadAsks, 'call', _10 => _10(client)])).items()
  ];
  console.log(`bids ${JSON.stringify(Array.from(res[0]), null, 2)}`);
  console.log(`asks ${JSON.stringify(Array.from(res[1]), null, 2)}`);
  return res;
}
main();


exports.DEVNET_SERUM3_MARKETS = DEVNET_SERUM3_MARKETS;
//# sourceMappingURL=devnet-user.js.map