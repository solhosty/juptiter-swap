{"version":3,"sources":["../../ts/client/src/debug-scripts/debug-perp.ts"],"sourcesContent":["import { AnchorProvider, Wallet } from '@project-serum/anchor';\nimport { Cluster, Connection, Keypair, PublicKey } from '@solana/web3.js';\nimport * as dotenv from 'dotenv';\nimport { MangoClient } from '../client';\nimport { MANGO_V4_ID } from '../constants';\ndotenv.config();\n\nconst CLUSTER_URL =\n  process.env.CLUSTER_URL_OVERRIDE || process.env.MB_CLUSTER_URL;\nconst PAYER_KEYPAIR =\n  process.env.PAYER_KEYPAIR_OVERRIDE || process.env.MB_PAYER_KEYPAIR;\nconst GROUP_PK =\n  process.env.GROUP_PK || '78b8f4cGCwmZ9ysPFMWLaLTkkaYnUjwMJYStWe5RTSSX';\nconst CLUSTER: Cluster =\n  (process.env.CLUSTER_OVERRIDE as Cluster) || 'mainnet-beta';\n\nasync function main(): Promise<void> {\n  const options = AnchorProvider.defaultOptions();\n  const connection = new Connection(CLUSTER_URL!, options);\n\n  const wallet = new Wallet(new Keypair());\n  const provider = new AnchorProvider(connection, wallet, options);\n  const client = MangoClient.connect(provider, CLUSTER, MANGO_V4_ID[CLUSTER], {\n    idsSource: 'get-program-accounts',\n  });\n\n  const group = await client.getGroup(new PublicKey(GROUP_PK));\n  const mangoAccounts = await client.getAllMangoAccounts(group);\n\n  Array.from(group.perpMarketsMapByMarketIndex.values())\n    .filter((perpMarket) => perpMarket.name != 'SOMETHING-PERP')\n    .map((perpMarket) => {\n      console.log(`name ${perpMarket.name}`);\n      let getUnsettledPnlUiAgg = 0;\n      let getBasePositionUiAgg = 0;\n      let longSettledFundingAgg = 0;\n      let shortSettledFundingAgg = 0;\n      mangoAccounts.map((mangoAccount) => {\n        const pp = mangoAccount\n          .perpActive()\n          .find((pp) => pp.marketIndex === perpMarket.perpMarketIndex);\n        if (pp) {\n          getUnsettledPnlUiAgg += pp.getUnsettledPnlUi(perpMarket);\n          getBasePositionUiAgg += pp.getBasePositionUi(perpMarket);\n          longSettledFundingAgg += pp.longSettledFunding.toNumber();\n          shortSettledFundingAgg += pp.shortSettledFunding.toNumber();\n          // console.log(` - ${mangoAccount.publicKey.toBase58().padStart(45)}`);\n          // console.log(\n          //   `    - unsettled pnl ${pp\n          //     .getUnsettledPnlUi(group, perpMarket)\n          //     .toFixed(4)\n          //     .padStart(10)}`,\n          // );\n          // console.log(\n          //   `    - base position ${pp\n          //     .getBasePositionUi(perpMarket)\n          //     .toFixed(4)\n          //     .padStart(10)}`,\n          // );\n          // console.log(\n          //   `    - avgEntryPricePerBaseLot ${pp.avgEntryPricePerBaseLot}`,\n          // );\n          // console.log(\n          //   `    - realizedTradePnl ${toUiDecimalsForQuote(\n          //     pp.realizedTradePnlNative,\n          //   )}`,\n          // );\n          // console.log(\n          //   `    - realizedOtherPnl ${toUiDecimalsForQuote(\n          //     pp.realizedOtherPnlNative,\n          //   )}`,\n          // );\n          // console.log(\n          //   `    - settlePnlLimitRealizedTrade ${pp.settlePnlLimitRealizedTrade.toNumber()}`,\n          // );\n          // console.log(\n          //   `    - realizedPnlForPosition ${toUiDecimalsForQuote(\n          //     pp.realizedPnlForPositionNative,\n          //   )}`,\n          // );\n          // console.log(\n          //   `    - settlePnlLimitSettledInCurrentWindow ${toUiDecimalsForQuote(\n          //     pp.settlePnlLimitSettledInCurrentWindowNative,\n          //   )}`,\n          // );\n        }\n      });\n      // console.log(\n      //   `- feesAccrued ${toUiDecimalsForQuote(perpMarket.feesAccrued)}`,\n      // );\n      // console.log(\n      //   `- feesSettled ${toUiDecimalsForQuote(perpMarket.feesSettled)}`,\n      // );\n      // console.log(\n      //   `- longSettledFundingAgg ${longSettledFundingAgg\n      //     .toFixed(4)\n      //     .padStart(10)}`,\n      // );\n      // console.log(\n      //   `- shortSettledFunding ${shortSettledFundingAgg\n      //     .toFixed(4)\n      //     .padStart(10)}`,\n      // );\n      console.log(\n        `- unsettled pnl aggr ${getUnsettledPnlUiAgg.toFixed(4).padStart(10)}`,\n      );\n      console.log(\n        `- base position aggr ${getBasePositionUiAgg.toFixed(4).padStart(10)}`,\n      );\n      console.log(\n        `- base position aggr * price ${(\n          getBasePositionUiAgg * perpMarket.uiPrice\n        )\n          .toFixed(4)\n          .padStart(10)}`,\n      );\n      console.log(\n        `- unsettled pnl aggr - base position aggr * price ${(\n          getUnsettledPnlUiAgg -\n          getBasePositionUiAgg * perpMarket.uiPrice\n        )\n          .toFixed(4)\n          .padStart(10)}`,\n      );\n      console.log();\n    });\n\n  process.exit();\n}\n\ntry {\n  main();\n} catch (error) {\n  console.log(error);\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA,SAAS,gBAAgB,cAAc;AACvC,SAAkB,YAAY,SAAS,iBAAiB;AACxD,YAAY,YAAY;AAGjB,cAAO;AAEd,IAAM,cACJ,QAAQ,IAAI,wBAAwB,QAAQ,IAAI;AAClD,IAAM,gBACJ,QAAQ,IAAI,0BAA0B,QAAQ,IAAI;AACpD,IAAM,WACJ,QAAQ,IAAI,YAAY;AAC1B,IAAM,UACH,QAAQ,IAAI,oBAAgC;AAE/C,eAAe,OAAsB;AACnC,QAAM,UAAU,eAAe,eAAe;AAC9C,QAAM,aAAa,IAAI,WAAW,aAAc,OAAO;AAEvD,QAAM,SAAS,IAAI,OAAO,IAAI,QAAQ,CAAC;AACvC,QAAM,WAAW,IAAI,eAAe,YAAY,QAAQ,OAAO;AAC/D,QAAM,SAAS,YAAY,QAAQ,UAAU,SAAS,YAAY,OAAO,GAAG;AAAA,IAC1E,WAAW;AAAA,EACb,CAAC;AAED,QAAM,QAAQ,MAAM,OAAO,SAAS,IAAI,UAAU,QAAQ,CAAC;AAC3D,QAAM,gBAAgB,MAAM,OAAO,oBAAoB,KAAK;AAE5D,QAAM,KAAK,MAAM,4BAA4B,OAAO,CAAC,EAClD,OAAO,CAAC,eAAe,WAAW,QAAQ,gBAAgB,EAC1D,IAAI,CAAC,eAAe;AACnB,YAAQ,IAAI,QAAQ,WAAW,MAAM;AACrC,QAAI,uBAAuB;AAC3B,QAAI,uBAAuB;AAC3B,QAAI,wBAAwB;AAC5B,QAAI,yBAAyB;AAC7B,kBAAc,IAAI,CAAC,iBAAiB;AAClC,YAAM,KAAK,aACR,WAAW,EACX,KAAK,CAACA,QAAOA,IAAG,gBAAgB,WAAW,eAAe;AAC7D,UAAI,IAAI;AACN,gCAAwB,GAAG,kBAAkB,UAAU;AACvD,gCAAwB,GAAG,kBAAkB,UAAU;AACvD,iCAAyB,GAAG,mBAAmB,SAAS;AACxD,kCAA0B,GAAG,oBAAoB,SAAS;AAAA,MAwC5D;AAAA,IACF,CAAC;AAiBD,YAAQ;AAAA,MACN,wBAAwB,qBAAqB,QAAQ,CAAC,EAAE,SAAS,EAAE;AAAA,IACrE;AACA,YAAQ;AAAA,MACN,wBAAwB,qBAAqB,QAAQ,CAAC,EAAE,SAAS,EAAE;AAAA,IACrE;AACA,YAAQ;AAAA,MACN,iCACE,uBAAuB,WAAW,SAEjC,QAAQ,CAAC,EACT,SAAS,EAAE;AAAA,IAChB;AACA,YAAQ;AAAA,MACN,sDACE,uBACA,uBAAuB,WAAW,SAEjC,QAAQ,CAAC,EACT,SAAS,EAAE;AAAA,IAChB;AACA,YAAQ,IAAI;AAAA,EACd,CAAC;AAEH,UAAQ,KAAK;AACf;AAEA,IAAI;AACF,OAAK;AACP,SAAS,OAAP;AACA,UAAQ,IAAI,KAAK;AACnB;","names":["pp"]}