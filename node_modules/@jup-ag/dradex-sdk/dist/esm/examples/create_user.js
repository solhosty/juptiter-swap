import { Provider } from "@project-serum/anchor";
import NodeWallet from "@project-serum/anchor/dist/cjs/nodewallet";
import { Keypair, Connection, PublicKey } from "@solana/web3.js";
import base58 from "bs58";
import { DexProgram } from "..";
// ENTER YOUR SECRET KEY HERE
const SECRET_KEY = "2EEPVAEnxwZe99oXDxTZC7b69aCwDYYxFiVwVXnE7fq9SeDR6zKRKvYLMsYcbmyjtWaV3fXYsMSY5QAdHK5DVLaR";
const KEYPAIR = Keypair.fromSecretKey(base58.decode(SECRET_KEY));
// SOL-USDC
const MARKET_ID = new PublicKey("CJept8TLyG9r2GMhttqR98zohVq274XCMiy5oxjTKKBt");
async function main() {
    const connection = new Connection("https://mercurial.rpcpool.com/2a059bc652a2c2635baad96cf70f");
    const provider = new Provider(connection, new NodeWallet(KEYPAIR), {
        commitment: "confirmed",
    });
    const dex = new DexProgram({ provider });
    const publicKey = new PublicKey("BUX7s2ef2htTGb2KKoPHWkmzxPj4nTWMWRgs5CSbQxf9");
    // fetch market
    const market = await dex.getMarket(MARKET_ID);
    await dex.loadMarket(market);
    // ensure that the MarketUser & DexUser exists
    const dexUserAddress = await dex.getDexUserAddress(publicKey);
    const marketUserAddress = await dex.getMarketUserAddress(market.address, publicKey);
    const [dexUser, marketUser] = await connection.getMultipleAccountsInfo([dexUserAddress, marketUserAddress]);
    const ix = dex.createInstructionSet([]);
    if (!dexUser) {
        ix.add(await dex.createDexUser(publicKey));
    }
    if (!marketUser) {
        ix.add(await dex.createMarketUser(market, publicKey));
    }
    const txId = await ix.exec({ skipPreflight: true });
    console.log("txId:", txId);
}
main();
