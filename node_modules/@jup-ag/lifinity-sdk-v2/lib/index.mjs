var M=Math.pow;var A=(i,n,e)=>new Promise((o,c)=>{var u=m=>{try{a(e.next(m))}catch(r){c(r)}},t=m=>{try{a(e.throw(m))}catch(r){c(r)}},a=m=>m.done?o(m.value):Promise.resolve(m.value).then(u,t);a((e=e.apply(i,n)).next())});import{Program as X,AnchorProvider as E}from"@project-serum/anchor";import{Keypair as $,PublicKey as I}from"@solana/web3.js";import T from"decimal.js";var z={version:"0.1.1",name:"lifinity_amm_v2",instructions:[{name:"initialize",accounts:[{name:"authority",isMut:!1,isSigner:!1},{name:"amm",isMut:!0,isSigner:!0},{name:"poolMint",isMut:!0,isSigner:!1},{name:"tokenA",isMut:!0,isSigner:!1},{name:"tokenB",isMut:!0,isSigner:!1},{name:"feeAccount",isMut:!0,isSigner:!1},{name:"destination",isMut:!0,isSigner:!1},{name:"oracleMainAccount",isMut:!1,isSigner:!1},{name:"oracleSubAccount",isMut:!1,isSigner:!1},{name:"oraclePcAccount",isMut:!1,isSigner:!1},{name:"tokenProgram",isMut:!1,isSigner:!1}],args:[{name:"baseDecimals",type:"u8"},{name:"ammFees",type:{defined:"AmmFees"}},{name:"ammCurve",type:{defined:"AmmCurve"}},{name:"ammConfig",type:{defined:"AmmConfig"}}]},{name:"swap",accounts:[{name:"authority",isMut:!1,isSigner:!1},{name:"amm",isMut:!0,isSigner:!1},{name:"userTransferAuthority",isMut:!1,isSigner:!0},{name:"sourceInfo",isMut:!0,isSigner:!1},{name:"destinationInfo",isMut:!0,isSigner:!1},{name:"swapSource",isMut:!0,isSigner:!1},{name:"swapDestination",isMut:!0,isSigner:!1},{name:"poolMint",isMut:!0,isSigner:!1},{name:"feeAccount",isMut:!0,isSigner:!1},{name:"tokenProgram",isMut:!1,isSigner:!1},{name:"oracleMainAccount",isMut:!1,isSigner:!1},{name:"oracleSubAccount",isMut:!1,isSigner:!1},{name:"oraclePcAccount",isMut:!1,isSigner:!1}],args:[{name:"amountIn",type:"u64"},{name:"minimumAmountOut",type:"u64"}]},{name:"depositAllTokenTypes",accounts:[{name:"amm",isMut:!0,isSigner:!1},{name:"authority",isMut:!1,isSigner:!1},{name:"userTransferAuthorityInfo",isMut:!1,isSigner:!0},{name:"sourceAInfo",isMut:!0,isSigner:!1},{name:"sourceBInfo",isMut:!0,isSigner:!1},{name:"tokenA",isMut:!0,isSigner:!1},{name:"tokenB",isMut:!0,isSigner:!1},{name:"poolMint",isMut:!0,isSigner:!1},{name:"destination",isMut:!0,isSigner:!1},{name:"tokenProgram",isMut:!1,isSigner:!1}],args:[{name:"poolTokenAmount",type:"u64"},{name:"maximumTokenAAmount",type:"u64"},{name:"maximumTokenBAmount",type:"u64"}]},{name:"withdrawAllTokenTypes",accounts:[{name:"amm",isMut:!0,isSigner:!1},{name:"authority",isMut:!1,isSigner:!1},{name:"userTransferAuthorityInfo",isMut:!1,isSigner:!0},{name:"sourceInfo",isMut:!0,isSigner:!1},{name:"tokenA",isMut:!0,isSigner:!1},{name:"tokenB",isMut:!0,isSigner:!1},{name:"poolMint",isMut:!0,isSigner:!1},{name:"destTokenAInfo",isMut:!0,isSigner:!1},{name:"destTokenBInfo",isMut:!0,isSigner:!1},{name:"tokenProgram",isMut:!1,isSigner:!1}],args:[{name:"poolTokenAmount",type:"u64"},{name:"minimumTokenAAmount",type:"u64"},{name:"minimumTokenBAmount",type:"u64"}]},{name:"ammOracleStatusUpdate",accounts:[{name:"amm",isMut:!0,isSigner:!0}],args:[{name:"oracleStatus",type:"u64"}]},{name:"ammFreezeUpdate",accounts:[{name:"amm",isMut:!0,isSigner:!0}],args:[{name:"freezeTrade",type:"u8"},{name:"freezeDeposit",type:"u8"},{name:"freezeWithdraw",type:"u8"},{name:"baseDecimals",type:"u8"}]},{name:"ammFeeCurveConfigUpdate",accounts:[{name:"amm",isMut:!0,isSigner:!0}],args:[{name:"ammFees",type:{defined:"AmmFees"}},{name:"ammCurve",type:{defined:"AmmCurve"}},{name:"ammConfig",type:{defined:"AmmConfig"}}]},{name:"ammLastPriceUpdate",accounts:[{name:"amm",isMut:!0,isSigner:!0}],args:[{name:"lastPrice",type:"u64"}]},{name:"ammRegressionTargetUpdate",accounts:[{name:"amm",isMut:!1,isSigner:!1},{name:"ammOwner",isMut:!1,isSigner:!0}],args:[{name:"targetAmount",type:"u64"}]}],accounts:[{name:"amm",type:{kind:"struct",fields:[{name:"initializerKey",type:"publicKey"},{name:"initializerDepositTokenAccount",type:"publicKey"},{name:"initializerReceiveTokenAccount",type:"publicKey"},{name:"initializerAmount",type:"u64"},{name:"takerAmount",type:"u64"},{name:"isInitialized",type:"bool"},{name:"bumpSeed",type:"u8"},{name:"freezeTrade",type:"u8"},{name:"freezeDeposit",type:"u8"},{name:"freezeWithdraw",type:"u8"},{name:"baseDecimals",type:"u8"},{name:"tokenProgramId",type:"publicKey"},{name:"tokenAAccount",type:"publicKey"},{name:"tokenBAccount",type:"publicKey"},{name:"poolMint",type:"publicKey"},{name:"tokenAMint",type:"publicKey"},{name:"tokenBMint",type:"publicKey"},{name:"feeAccount",type:"publicKey"},{name:"oracleMainAccount",type:"publicKey"},{name:"oracleSubAccount",type:"publicKey"},{name:"oraclePcAccount",type:"publicKey"},{name:"fees",type:{defined:"AmmFees"}},{name:"curve",type:{defined:"AmmCurve"}},{name:"config",type:{defined:"AmmConfig"}},{name:"ammPTemp1",type:"publicKey"},{name:"ammPTemp2",type:"publicKey"},{name:"ammPTemp3",type:"publicKey"},{name:"ammPTemp4",type:"publicKey"},{name:"ammPTemp5",type:"publicKey"}]}}],types:[{name:"AmmFees",type:{kind:"struct",fields:[{name:"tradeFeeNumerator",type:"u64"},{name:"tradeFeeDenominator",type:"u64"},{name:"ownerTradeFeeNumerator",type:"u64"},{name:"ownerTradeFeeDenominator",type:"u64"},{name:"ownerWithdrawFeeNumerator",type:"u64"},{name:"ownerWithdrawFeeDenominator",type:"u64"},{name:"hostFeeNumerator",type:"u64"},{name:"hostFeeDenominator",type:"u64"}]}},{name:"AmmCurve",type:{kind:"struct",fields:[{name:"curveType",type:"u8"},{name:"curveParameters",type:"u64"}]}},{name:"AmmConfig",type:{kind:"struct",fields:[{name:"lastPrice",type:"u64"},{name:"lastBalancedPrice",type:"u64"},{name:"configDenominator",type:"u64"},{name:"volumeX",type:"u64"},{name:"volumeY",type:"u64"},{name:"volumeXInY",type:"u64"},{name:"depositCap",type:"u64"},{name:"regressionTarget",type:"u64"},{name:"oracleType",type:"u64"},{name:"oracleStatus",type:"u64"},{name:"oracleMainSlotLimit",type:"u64"},{name:"oracleSubConfidenceLimit",type:"u64"},{name:"oracleSubSlotLimit",type:"u64"},{name:"oraclePcConfidenceLimit",type:"u64"},{name:"oraclePcSlotLimit",type:"u64"},{name:"stdSpread",type:"u64"},{name:"stdSpreadBuffer",type:"u64"},{name:"spreadCoefficient",type:"u64"},{name:"priceBufferCoin",type:"i64"},{name:"priceBufferPc",type:"i64"},{name:"rebalanceRatio",type:"u64"},{name:"feeTrade",type:"u64"},{name:"feePlatform",type:"u64"},{name:"configTemp3",type:"u64"},{name:"configTemp4",type:"u64"},{name:"configTemp5",type:"u64"},{name:"configTemp6",type:"u64"},{name:"configTemp7",type:"u64"},{name:"configTemp8",type:"u64"}]}},{name:"CurveType",type:{kind:"enum",variants:[{name:"Standard"},{name:"ConstantProduct"}]}},{name:"TradeDirection",type:{kind:"enum",variants:[{name:"AtoB"},{name:"BtoA"}]}},{name:"RoundDirection",type:{kind:"enum",variants:[{name:"Floor"},{name:"Ceiling"}]}}],errors:[{code:6e3,name:"AlreadyInUse",msg:"Swap account already in use"},{code:6001,name:"InvalidProgramAddress",msg:"Invalid program address generated from bump seed and key"},{code:6002,name:"InvalidOwner",msg:"Input account owner is not the program address"},{code:6003,name:"InvalidOutputOwner",msg:"Output pool account owner cannot be the program address"},{code:6004,name:"ExpectedMint",msg:"Deserialized account is not an SPL Token mint"},{code:6005,name:"ExpectedAccount",msg:"Deserialized account is not an SPL Token account"},{code:6006,name:"EmptySupply",msg:"Input token account empty"},{code:6007,name:"InvalidSupply",msg:"Pool token mint has a non-zero supply"},{code:6008,name:"InvalidDelegate",msg:"Token account has a delegate"},{code:6009,name:"InvalidInput",msg:"InvalidInput"},{code:6010,name:"IncorrectSwapAccount",msg:"Address of the provided swap token account is incorrect"},{code:6011,name:"IncorrectPoolMint",msg:"Address of the provided pool token mint is incorrect"},{code:6012,name:"InvalidOutput",msg:"InvalidOutput"},{code:6013,name:"CalculationFailure",msg:"General calculation failure due to overflow or underflow"},{code:6014,name:"InvalidInstruction",msg:"Invalid instruction"},{code:6015,name:"RepeatedMint",msg:"Swap input token accounts have the same mint"},{code:6016,name:"ExceededSlippage",msg:"Swap instruction exceeds desired slippage limit"},{code:6017,name:"InvalidCloseAuthority",msg:"Token account has a close authority"},{code:6018,name:"InvalidFreezeAuthority",msg:"Pool token mint has a freeze authority"},{code:6019,name:"IncorrectFeeAccount",msg:"Pool fee token account incorrect"},{code:6020,name:"ZeroTradingTokens",msg:"Given pool token amount results in zero trading tokens"},{code:6021,name:"FeeCalculationFailure",msg:"Fee calculation failed due to overflow, underflow, or unexpected 0"},{code:6022,name:"ConversionFailure",msg:"Conversion to u64 failed with an overflow or underflow"},{code:6023,name:"InvalidFee",msg:"The provided fee does not match the program owner's constraints"},{code:6024,name:"IncorrectTokenProgramId",msg:"The provided token program does not match the token program expected by the swap"},{code:6025,name:"IncorrectOracleAccount",msg:"Address of the provided oracle account is incorrect"},{code:6026,name:"IncorrectConfigAccount",msg:"Address of the provided config account is incorrect"},{code:6027,name:"UnsupportedCurveType",msg:"The provided curve type is not supported by the program owner"},{code:6028,name:"InvalidCurve",msg:"The provided curve parameters are invalid"},{code:6029,name:"UnsupportedCurveOperation",msg:"The operation cannot be performed on the given curve"},{code:6030,name:"InvalidPythStatus",msg:"Pyth oracle status is not 'trading'"},{code:6031,name:"InvalidPythPrice",msg:"Could not retrieve updated price feed from the Pyth oracle"},{code:6032,name:"IncorrectSigner",msg:"Address of the provided signer account is incorrect"},{code:6033,name:"ExceedPoolBalance",msg:"Swap amount exceeds pool balance"},{code:6034,name:"ProgramIsFrozen",msg:"Program is frozen"},{code:6035,name:"OracleConfidence",msg:"Oracle confidence is too low"},{code:6036,name:"OverCapAmount",msg:"Over Pool Cap Amount"},{code:6037,name:"InvalidUpdateAccount",msg:"Invalid update wallet address"}]};var R=()=>"2wT8Yq49kHgDzXuPxZSaeLaH1qbmGXtEyPy64bL7aD3c";function Ce(){return ce}function B(i,n){let e=Object.values(ce).filter(o=>o.poolCoinMint===i&&o.poolPcMint===n||o.poolCoinMint===n&&o.poolPcMint===i);return e.length===1?e[0]:null}var ce={"SOL-USDC":{amm:"86eq4kdBkUCHGdCC2SfcqGHRCBGhp2M89aCmuvvxaXsm",poolMint:"FbQYjLEq1vNCszmxmxZDoFiy9fgyfdPxzt9Fu5zk5jJ4",feeAccount:"FX5PBDb4nVTs4f9dSkUsj55rEYrCkBs9e7xZpDHqDeVM",oracleMainAccount:"EPBJUVCmzvwkGPGcEuwKmXomfGt78Aozy6pj44x9xxDB",oracleSubAccount:"H6ARHf6YXhGYeQfUzQNGk6rDNnLBQKrenN712K4AQJEG",oraclePcAccount:"CdgEC82BZAxFAJFpVPZ1RtnDr9AyH8KP9KygYhCb39eJ",poolCoinTokenAccount:"6Nij2pGdpgd6EutLAtdRwQoHaKKxhdNBi4zoLgd9Yuaq",poolCoinMint:"So11111111111111111111111111111111111111112",poolPcTokenAccount:"ELFYDkPYWBopH5Msm2cbA2ueByCXEKpzKWanv1kZC9L2",poolPcMint:"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",poolCoinDecimal:9,poolPcDecimal:6,poolMintDecimal:9,pythBaseDecimal:11},"SOL-USDT":{amm:"EiEAydLqSKFqRPpuwYoVxEJ6h9UZh9tsTaHgs4f8b8Z5",poolMint:"2e6NAJy1qaKMq8PaswP2uzimMDvbr71Tbw38G6q9SNZ2",feeAccount:"2EVZT2cFMvbqE9nSVidYVkrSouKfudcKG6R8AKiXoSY9",oracleMainAccount:"EPBJUVCmzvwkGPGcEuwKmXomfGt78Aozy6pj44x9xxDB",oracleSubAccount:"H6ARHf6YXhGYeQfUzQNGk6rDNnLBQKrenN712K4AQJEG",oraclePcAccount:"3ZDBff7jeQaksmGvmkRix36rU159EBDjYiPThvV8QVZM",poolCoinTokenAccount:"GUicRosQyLJCYG8hjYcbiGKAVAmT1puQTVmJjFxJmdMK",poolCoinMint:"So11111111111111111111111111111111111111112",poolPcTokenAccount:"D8F3PPxSuykAgyPPKwQdXDGGoRnUXzxowaheVJw5ATDC",poolPcMint:"Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",poolCoinDecimal:9,poolPcDecimal:6,poolMintDecimal:9,pythBaseDecimal:11}};import{BN as F}from"@project-serum/anchor";import{Keypair as le,PublicKey as h,Transaction as Ee}from"@solana/web3.js";import{Token as ze}from"@solana/spl-token";import{TOKEN_PROGRAM_ID as ae}from"@solana/spl-token";import{closeAccount as We}from"@project-serum/serum/lib/token-instructions";var k={symbol:"WSOL",mintAddress:"So11111111111111111111111111111111111111112",decimals:9};import{BorshAccountsCoder as Ne}from"@project-serum/anchor";import{Keypair as Be,PublicKey as J,SystemProgram as xe}from"@solana/web3.js";import{Token as ue}from"@solana/spl-token";import{initializeAccount as Le}from"@project-serum/serum/lib/token-instructions";import{AccountLayout as _,TOKEN_PROGRAM_ID as H,u64 as me}from"@solana/spl-token";import{parsePriceData as ee}from"@pythnetwork/client";import P from"decimal.js";var ne=new J("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");function W(i,n,e,o,c,u){return A(this,null,function*(){let t;if(e)t=e;else{let a=n.wallet.publicKey,m=Be.generate();t=m.publicKey;let r=o+(yield i.provider.connection.getMinimumBalanceForRentExemption(_.span));c.add(xe.createAccount({fromPubkey:a,newAccountPubkey:t,lamports:r,space:_.span,programId:H})),c.add(Le({account:t,mint:new J(k.mintAddress),owner:a})),u.push(m)}return t})}function U(i,n,e,o){return A(this,null,function*(){let c=yield q(n.wallet.publicKey,e);return yield i.provider.connection.getAccountInfo(c).then(u=>A(this,null,function*(){u||(c=yield ue.getAssociatedTokenAddress(ne,H,e,n.wallet.publicKey),o.add(ue.createAssociatedTokenAccountInstruction(ne,H,e,c,n.wallet.publicKey,n.wallet.publicKey)))})),c})}function q(i,n){return A(this,null,function*(){let{publicKey:e}=yield Oe([i.toBuffer(),H.toBuffer(),n.toBuffer()],ne);return e})}function Oe(i,n){return A(this,null,function*(){let[e,o]=yield J.findProgramAddress(i,n);return{publicKey:e,nonce:o}})}function V(i,n){return A(this,null,function*(){let[e,o]=yield J.findProgramAddress([n.toBuffer()],i);return{programAuthority:e,nonce:o}})}function te(i,n,e){return A(this,null,function*(){let o=[],c=[];n.forEach(a=>{c.length>=100&&(o.push(c),c=[]),c.push(a)}),c.length>0&&o.push(c);let u=[],t={};return yield Promise.all(o.map((a,m)=>A(this,null,function*(){let r=yield i.getMultipleAccountsInfo(a,e);t[m]=r}))),Object.keys(t).sort((a,m)=>parseInt(a)-parseInt(m)).forEach(a=>{let m=t[parseInt(a)];for(let r of m)u.push(r)}),u.map((a,m)=>a===null?null:{publicKey:n[m],account:a})})}function oe(i,n){let e,o,c,u,t,a,m,r;for(let s=0;s<i.length;s++){let d=i[s];if(d){let f=d.publicKey.toBase58(),l=Buffer.from(d.account.data),{key:g}=Fe(n,f);switch(g){case"amm":{let w=new Ne(z).decode("amm",l),p=w.config,S=w.fees,v=w.curve;e={freezeTrade:w.freezeTrade,freezeDeposit:w.freezeDeposit,freezeWithdraw:w.freezeWithdraw,baseDecimals:w.baseDecimals,curveType:v.curveType},o={tradeFeeNumerator:new P(Number(S.tradeFeeNumerator)),tradeFeeDenominator:new P(Number(S.tradeFeeDenominator)),ownerTradeFeeNumerator:new P(Number(S.ownerTradeFeeNumerator)),ownerTradeFeeDenominator:new P(Number(S.ownerTradeFeeDenominator))},t={lastPrice:new P(Number(p.lastPrice)),lastBalancedPrice:new P(Number(p.lastBalancedPrice)),configDenominator:new P(Number(p.configDenominator)),oracleMainSlotLimit:new P(Number(p.oracleMainSlotLimit)),oracleSubConfidenceLimit:new P(Number(p.oracleSubConfidenceLimit)),oracleSubSlotLimit:new P(Number(p.oracleSubSlotLimit)),oraclePcConfidenceLimit:new P(Number(p.oraclePcConfidenceLimit)),oraclePcSlotLimit:new P(Number(p.oraclePcSlotLimit)),volumeX:new P(Number(p.volumeX)),volumeY:new P(Number(p.volumeY)),volumeXinY:new P(Number(p.volumeXInY)),oracleStatus:new P(Number(p.oracleStatus)),depositCap:new P(Number(p.depositCap)),regressionTarget:new P(Number(p.regressionTarget)),stdSpread:new P(Number(p.stdSpread)),stdSpreadBuffer:new P(Number(p.stdSpreadBuffer)),spreadCoefficient:new P(Number(p.spreadCoefficient)),priceBufferCoin:new P(Number(p.priceBufferCoin)),priceBufferPc:new P(Number(p.priceBufferPc)),oracleType:new P(Number(p.oracleType)),rebalanceRatio:new P(Number(p.rebalanceRatio))};break}case"poolCoinTokenAccount":{let y=_.decode(l),w=me.fromBuffer(y.amount).toNumber();c=new P(w);break}case"poolPcTokenAccount":{let y=_.decode(l),w=me.fromBuffer(y.amount).toNumber();u=new P(w);break}case"oracleMainAccount":{let{aggregate:y,exponent:w}=ee(l),p=new P(Number(y.priceComponent)),S=new P(Number(y.confidenceComponent)),v=new P(Number(y.status)),D=new P(Number(y.publishSlot));a={address:f,price:p,confidence:S,status:v,publishSlot:D,exponent:w};break}case"oracleSubAccount":{let{aggregate:y,exponent:w}=ee(l),p=new P(Number(y.priceComponent)),S=new P(Number(y.confidenceComponent)),v=new P(Number(y.status)),D=new P(Number(y.publishSlot));m={address:f,price:p,confidence:S,status:v,publishSlot:D,exponent:w};break}case"oraclePcAccount":{let{aggregate:y,exponent:w}=ee(l),p=new P(Number(y.priceComponent)),S=new P(Number(y.confidenceComponent)),v=new P(Number(y.status)),D=new P(Number(y.publishSlot));r={address:f,price:p,confidence:S,status:v,publishSlot:D,exponent:w};break}}}}return{amm:e,fees:o,coinBalance:c,pcBalance:u,config:t,oracleMain:a,oracleSub:m,oraclePc:r}}function Fe(i,n){for(let[e,o]of Object.entries(i))if(o===n)return{key:e};return{}}function ie(i,n){return A(this,null,function*(){let e=yield i._rpcRequest("getTokenAccountBalance",[n.toBase58()]);if(e.error)throw new Error(e.error.message);return e.result})}function se(i,n){return A(this,null,function*(){let e=yield i._rpcRequest("getTokenSupply",[n.toBase58()]);if(e.error)throw new Error(e.error.message);return e.result})}function pe(i,n,e,o,c,u,t){return A(this,null,function*(){let{transaction:a,signers:m}=yield Re(i,n,o,c,e,u,t);return yield n.sendAndConfirm(a,m)})}function de(i,n,e,o,c,u,t,a,m,r,s=!0){return A(this,null,function*(){let d=null,f=[],l=new F(e.toNumber()),g=new F(o.toNumber()),y=null;s&&(y=le.generate(),d=yield fe(c,u,y.publicKey,l),f.push(y));let w=yield ye(i,y?y.publicKey:c,u,t,a,m,r,l,g,n);return{approveInstruction:d,swapInstruction:w,signers:f}})}function Re(i,n,e,o,c,u,t){return A(this,null,function*(){let a=new Ee,m=[],r,s,d,f,l=new h(c.feeAccount),g=10,y=Math.pow(g,c.poolCoinDecimal),w=Math.pow(g,c.poolPcDecimal);e.toString()===c.poolCoinMint?(r=new F(u*y),s=new F(t*w),d=new h(c.poolCoinTokenAccount),f=new h(c.poolPcTokenAccount)):(r=new F(u*w),s=new F(t*y),d=new h(c.poolPcTokenAccount),f=new h(c.poolCoinTokenAccount));let p=null,S=null;return e.toString()===k.mintAddress?p=yield W(i,n,p,r.toNumber(),a,m):p=yield q(n.wallet.publicKey,e),o.toString()===k.mintAddress?S=yield W(i,n,S,0,a,m):S=yield U(i,n,o,a),yield qe(i,n,a,m,p,S,d,f,l,r,s,c,!0),o.toString()===k.mintAddress&&a.add(We({source:S,destination:n.wallet.publicKey,owner:n.wallet.publicKey})),{transaction:a,signers:m}})}function qe(i,n,e,o,c,u,t,a,m,r,s,d,f=!0){return A(this,null,function*(){let l;f?(l=le.generate(),e.add(yield fe(n.wallet.publicKey,c,l.publicKey,r)),o.push(l)):l=n.wallet,e.add(yield ye(i,l.publicKey,c,u,t,a,m,r,s,d))})}function fe(i,n,e,o){return A(this,null,function*(){return ze.createApproveInstruction(ae,n,e,i,[],o.toNumber())})}function ye(i,n,e,o,c,u,t,a,m,r){return A(this,null,function*(){let{programAuthority:s}=yield V(i.programId,new h(r.amm));return yield i.methods.swap(a,m).accounts({authority:s,amm:new h(r.amm),userTransferAuthority:n,sourceInfo:e,destinationInfo:o,swapSource:c,swapDestination:u,poolMint:new h(r.poolMint),feeAccount:t,tokenProgram:ae,oracleMainAccount:new h(r.oracleMainAccount),oracleSubAccount:new h(r.oracleSubAccount),oraclePcAccount:new h(r.oraclePcAccount)}).instruction()})}function we(i,n,e,o,c,u,t,a,m){return A(this,null,function*(){let r,s,d,f,l=new h(a.feeAccount),g=10,y=Math.pow(g,a.poolCoinDecimal),w=Math.pow(g,a.poolPcDecimal);return t.toString()===a.poolCoinMint?(r=new F(n*y),s=new F(e*w),d=new h(a.poolCoinTokenAccount),f=new h(a.poolPcTokenAccount)):(r=new F(n*w),s=new F(e*y),d=new h(a.poolPcTokenAccount),f=new h(a.poolCoinTokenAccount)),yield Ge(i,o,c,u,d,f,l,r,s,a,m)})}function Ge(i,n,e,o,c,u,t,a,m,r,s){return A(this,null,function*(){return yield i.methods.swap(a,m).accounts({authority:s,amm:new h(r.amm),userTransferAuthority:n,sourceInfo:e,destinationInfo:o,swapSource:c,swapDestination:u,poolMint:new h(r.poolMint),feeAccount:t,tokenProgram:ae,oracleMainAccount:new h(r.oracleMainAccount),oracleSubAccount:new h(r.oracleSubAccount),oraclePcAccount:new h(r.oraclePcAccount)}).instruction()})}import K from"decimal.js";var x={AtoB:"AtoB",BtoA:"BtoA"};function re(i,n,e,o,c,u,t,a,m,r,s){let d=new K(0),f=new K(0),l=i.times(o.tradeFeeNumerator).div(o.tradeFeeDenominator),g=i.times(o.ownerTradeFeeNumerator).div(o.ownerTradeFeeDenominator);!l.isZero()&&l.lt(1)&&(l=new K(1)),!g.isZero()&&g.lt(1)&&(g=new K(1));let y=l.plus(g).floor(),w=o.tradeFeeNumerator.div(o.tradeFeeDenominator).plus(o.ownerTradeFeeNumerator.div(o.ownerTradeFeeDenominator)),p=i.minus(y),S=new K(10),v=S.pow(e.baseDecimals);if(e.freezeTrade===1)throw new Error("ProgramIsFrozen");let D,N;if(t.oracleType.eq(0)){let O=!1;if(!a.status.eq(1))throw new Error("InvalidPythMainStatus");if(n-a.publishSlot.toNumber()>t.oracleMainSlotLimit.toNumber())if(m&&a.address!=m.address)O=!0;else throw new Error("InvalidPythMainSlot");if(D=a.price,N=a.confidence,O){if(N=new K(0),!m.status.eq(1))throw new Error("InvalidPythSubStatus");if(n-m.publishSlot.toNumber()>t.oracleSubSlotLimit.toNumber())throw new Error("InvalidPythSubSlot");if(m.confidence.div(m.price).gt(t.oracleSubConfidenceLimit.div(t.configDenominator)))throw new Error("InvalidPythSubConfidence");D=m.price}}else{if(N=new K(0),!m.status.eq(1))throw new Error("InvalidPythSubStatus");if(n-m.publishSlot.toNumber()>t.oracleSubSlotLimit.toNumber())throw new Error("InvalidPythSubSlot");if(m.confidence.div(m.price).gt(t.oracleSubConfidenceLimit.div(t.configDenominator)))throw new Error("InvalidPythSubConfidence");D=m.price}if(r){if(!r.status.eq(1))throw new Error("InvalidPythPcStatus");if(n-r.publishSlot.toNumber()>t.oraclePcSlotLimit.toNumber())throw new Error("InvalidPythPcSlot");if(r.confidence.div(r.price).gt(t.oraclePcConfidenceLimit.div(t.configDenominator)))throw new Error("InvalidPythPcConfidence");D=D.times(S.pow(Math.abs(r.exponent))).div(r.price)}let Z=D;if(t.oracleStatus.eq(1)&&s===x.AtoB)throw new Error("OracleConfidence");if(t.oracleStatus.eq(2)&&s===x.BtoA)throw new Error("OracleConfidence");if(e.curveType===0){let{destinationAmountSwapped:O,poolPriceImpact:G}=Ue(p,Z,v,N,c,u,t,s);d=O,f=G}else if(e.curveType===1){let{destinationAmountSwapped:O,poolPriceImpact:G}=Ve(p,Z,v,c,u,t,s);d=O,f=G}if(d.lt(1))throw new Error("ZeroAmountOut");if(s===x.AtoB&&d.gte(u))throw new Error("ExceedPoolBalance");if(s===x.BtoA&&d.gte(c))throw new Error("ExceedPoolBalance");return{amountSwapped:d,priceImpact:f,fee:y,feePercent:w}}function Ue(i,n,e,o,c,u,t,a){let m=new K(0),r=new K(0);switch(a){case x.AtoB:{let s=n.times(t.priceBufferCoin.div(t.configDenominator).add(1)),f=c.plus(i).div(t.regressionTarget).minus(1),l=0;f.lt(0)?l=0:l=f.pow(t.spreadCoefficient.div(t.configDenominator)).times(t.stdSpread.div(t.configDenominator)).plus(t.stdSpreadBuffer.div(t.configDenominator)).toNumber(),l>1&&(l=.99);let g=s.times(1-l).minus(o).floor();m=i.times(g.div(e)).floor();let y=m.div(i).mul(e).floor();r=s.minus(y).div(s);break}case x.BtoA:{let s=n.times(t.priceBufferPc.div(t.configDenominator).add(1)),d=c,l=t.regressionTarget.times(2).minus(d).times(s).div(e).plus(i).div(t.regressionTarget.times(s).div(e)).minus(1),g=0;l.lt(0)?g=0:g=l.pow(t.spreadCoefficient.div(t.configDenominator)).times(t.stdSpread.div(t.configDenominator)).plus(t.stdSpreadBuffer.div(t.configDenominator)).toNumber(),g>1&&(g=.99);let y=s.times(1+g).plus(o).floor();m=i.div(y.div(e)).floor(),r=i.div(m).mul(e).floor().minus(s).div(s);break}}return{destinationAmountSwapped:m,poolPriceImpact:r}}function Ve(i,n,e,o,c,u,t){let a=new K(0),m=new K(0);switch(t){case x.AtoB:{let r=o,s=c,d=r.times(s),f=r.plus(i),{q:l,r:g}=ge(d,f),y=l.floor();f=g.floor(),a=s.minus(y).floor();let w=s.div(r),p=s.minus(a).div(r.plus(i));m=w.minus(p).div(w);break}case x.BtoA:{let r=o,s=c,d=r.times(s),f=s.plus(i),{q:l,r:g}=ge(d,f),y=l.floor();f=g.floor(),a=r.minus(y).floor();let w=s.div(r),p=s.plus(i).div(r.minus(a));m=p.minus(w).div(p);break}}return{destinationAmountSwapped:a,poolPriceImpact:m}}function ge(i,n){let e=n,o=i.div(e);return o.eq(0)?{q:new K(0),r:new K(0)}:(i.mod(n).gt(0)&&(o=o.plus(1),e=i.div(o),i.mod(o).gt(0)&&(e=e.plus(1))),{q:o,r:e})}import{PublicKey as b,Transaction as Pe}from"@solana/web3.js";import{BN as L}from"@project-serum/anchor";import{TOKEN_PROGRAM_ID as j}from"@solana/spl-token";import C from"decimal.js";import{closeAccount as Q}from"@project-serum/serum/lib/token-instructions";function be(i,n,e,o,c,u){return A(this,null,function*(){if(!e)return console.log("Pool Not Found"),"";let{transaction:t,signers:a}=yield Ye(i,n,e,o,c,u);return yield n.sendAndConfirm(t,a)})}function Ye(i,n,e,o,c,u){return A(this,null,function*(){let t=new Pe,a=[],m=10,r=Math.pow(m,e.poolCoinDecimal),s=Math.pow(m,e.poolPcDecimal),d=Math.pow(m,e.poolMintDecimal),f=new L(o*r),l=new L(c*s),g=new L(u*d),y=yield U(i,n,new b(e.poolMint),t),w=null,p=null;e.poolCoinMint===k.mintAddress?w=yield W(i,n,w,f.toNumber(),t,a):w=yield q(n.wallet.publicKey,new b(e.poolCoinMint)),e.poolPcMint===k.mintAddress?p=yield W(i,n,p,0,t,a):p=yield q(n.wallet.publicKey,new b(e.poolPcMint));let S=n.wallet.publicKey,{programAuthority:v}=yield V(i.programId,new b(e.amm));return t.add(yield i.methods.depositAllTokenTypes(g,f,l).accounts({amm:new b(e.amm),authority:v,userTransferAuthorityInfo:S,sourceAInfo:w,sourceBInfo:p,tokenA:new b(e.poolCoinTokenAccount),tokenB:new b(e.poolPcTokenAccount),poolMint:new b(e.poolMint),destination:y,tokenProgram:j}).instruction()),e.poolCoinMint===k.mintAddress&&t.add(Q({source:w,destination:n.wallet.publicKey,owner:n.wallet.publicKey})),e.poolPcMint===k.mintAddress&&t.add(Q({source:p,destination:n.wallet.publicKey,owner:n.wallet.publicKey})),{transaction:t,signers:a}})}function Se(i,n,e,o,c){return A(this,null,function*(){let u=yield se(i,new b(o.poolMint)),t=new C(u.value.amount),a=yield ie(i,new b(o.poolCoinTokenAccount)),m=new C(a.value.amount),r=yield ie(i,new b(o.poolPcTokenAccount)),s=new C(r.value.amount),d=o.poolCoinMint,f=o.poolPcMint,l=(100-c)/100,g=new C(0),y=new C(0),w=new C(0),p=new C(0);if(!n.isZero()){let S=Ae(o,n.times(M(10,o.poolCoinDecimal)),d,f,m,s);g=n.times(M(10,o.poolCoinDecimal)).div(m).times(t).times(l).floor().div(M(10,o.poolMintDecimal)),y=S.div(M(10,o.poolPcDecimal))}if(!e.isZero()){let S=Ae(o,e.times(M(10,o.poolPcDecimal)),f,d,m,s);w=e.times(M(10,o.poolPcDecimal)).div(s).times(t).times(l).floor().div(M(10,o.poolMintDecimal)),p=S.div(M(10,o.poolCoinDecimal))}return e.isZero()?{coinIn:n.toNumber(),pcIn:y.toNumber(),lpRecive:g.toNumber()}:n.isZero()?{coinIn:p.toNumber(),pcIn:e.toNumber(),lpRecive:w.toNumber()}:n.lt(p)?{coinIn:n.toNumber(),pcIn:y.toNumber(),lpRecive:g.toNumber()}:{coinIn:p.toNumber(),pcIn:e.toNumber(),lpRecive:w.toNumber()}})}function Ae(i,n,e,o,c,u){let t=u.div(c),a=new C(0);return!c||!u||(e===i.poolCoinMint&&o===i.poolPcMint?a=n.times(t).floor():e===i.poolPcMint&&o===i.poolCoinMint&&(a=n.div(t).floor())),a}function he(i,n,e,o,c,u,t,a,m){return A(this,null,function*(){let r=u,s=new L(e*M(10,n.poolCoinDecimal)),d=new L(o*M(10,n.poolPcDecimal)),f=new L(c*M(10,n.poolMintDecimal)),[l]=yield b.findProgramAddress([new b(n.amm).toBuffer()],i.programId);return yield i.methods.depositAllTokenTypes(f,s,d).accounts({amm:new b(n.amm),authority:l,userTransferAuthorityInfo:r,sourceAInfo:t,sourceBInfo:a,tokenA:new b(n.poolCoinTokenAccount),tokenB:new b(n.poolPcTokenAccount),poolMint:new b(n.poolMint),destination:m,tokenProgram:j}).instruction()})}function Ie(i,n,e,o,c,u){return A(this,null,function*(){if(!e)return console.log("Pool Not Found"),"";let{transaction:t,signers:a}=yield Xe(i,n,e,o,c,u);return yield n.sendAndConfirm(t,a)})}function Xe(i,n,e,o,c,u){return A(this,null,function*(){let t=new Pe,a=[],m=10,r=Math.pow(m,e.poolCoinDecimal),s=Math.pow(m,e.poolPcDecimal),d=Math.pow(m,e.poolMintDecimal),f=new L(c*r),l=new L(u*s),g=new L(o*d),y=yield q(n.wallet.publicKey,new b(e.poolMint)),w=null,p=null;e.poolCoinMint===k.mintAddress?w=yield W(i,n,w,1e7,t,a):w=yield U(i,n,new b(e.poolCoinMint),t),e.poolPcMint===k.mintAddress?p=yield W(i,n,p,1e7,t,a):p=yield U(i,n,new b(e.poolPcMint),t);let{programAuthority:S}=yield V(i.programId,new b(e.amm));return t.add(yield i.methods.withdrawAllTokenTypes(g,f,l).accounts({amm:new b(e.amm),authority:S,userTransferAuthorityInfo:n.wallet.publicKey,sourceInfo:y,tokenA:new b(e.poolCoinTokenAccount),tokenB:new b(e.poolPcTokenAccount),poolMint:new b(e.poolMint),destTokenAInfo:w,destTokenBInfo:p,tokenProgram:j}).instruction()),e.poolCoinMint===k.mintAddress&&t.add(Q({source:w,destination:n.wallet.publicKey,owner:n.wallet.publicKey})),e.poolPcMint===k.mintAddress&&t.add(Q({source:p,destination:n.wallet.publicKey,owner:n.wallet.publicKey})),{transaction:t,signers:a}})}function Te(i,n,e,o){return A(this,null,function*(){let c=n.times(Math.pow(10,e.poolMintDecimal)),u=yield i.getTokenSupply(new b(e.poolMint)),t=new C(u.value.amount),a=yield i.getTokenAccountBalance(new b(e.poolCoinTokenAccount)),m=new C(a.value.amount),r=yield i.getTokenAccountBalance(new b(e.poolPcTokenAccount)),s=new C(r.value.amount),d=new C(100).plus(o).dividedBy(100),f=c.div(d),l=m.times(f).div(t).floor().div(M(10,e.poolCoinDecimal)).toNumber(),g=s.times(f).div(t).floor().div(M(10,e.poolPcDecimal)).toNumber();return{coinOut:l,pcOut:g}})}function ve(i,n,e,o,c,u,t,a,m){return A(this,null,function*(){let r=new C(e).times(Math.pow(10,n.poolMintDecimal)),s=new L(r.toNumber()),d=new L(o*Math.pow(10,n.poolCoinDecimal)),f=new L(c*Math.pow(10,n.poolPcDecimal)),[l]=yield b.findProgramAddress([new b(n.amm).toBuffer()],i.programId);return yield i.methods.withdrawAllTokenTypes(s,d,f).accounts({amm:new b(n.amm),authority:l,userTransferAuthorityInfo:u,sourceInfo:m,tokenA:new b(n.poolCoinTokenAccount),tokenB:new b(n.poolPcTokenAccount),poolMint:new b(n.poolMint),destTokenAInfo:t,destTokenBInfo:a,tokenProgram:j}).instruction()})}var Y=class{constructor(n,e){this.stateAddress=I.default;this.programAuthority=I.default;this.connection=n,this.wallet=e;let o=new I(R());this.provider=new E(n,e,E.defaultOptions()),this.program=new X(z,o,this.provider)}static build(n,e){return A(this,null,function*(){return new Y(n,e)})}swap(n,e,o,c){return A(this,null,function*(){let u=B(o.toString(),c.toString());try{return yield pe(this.program,this.provider,u,o,c,n,e)}catch(t){return console.error(t),""}})}deposit(n,e,o,c,u){return A(this,null,function*(){let t=B(c.toString(),u.toString());try{return yield be(this.program,this.provider,t,n,e,o)}catch(a){return console.error(a),""}})}withdraw(n,e,o,c,u){return A(this,null,function*(){let t=B(c.toString(),u.toString());try{return yield Ie(this.program,this.provider,t,n,e,o)}catch(a){return console.error(a),""}})}};function Ze(i,n,e,o,c){return A(this,null,function*(){let u=B(e.toString(),o.toString());if(u){let t=new T(n),a,m,r;u.poolCoinMint===e.toString()?(t=t.times(new T(10).pow(u.poolCoinDecimal)),m=u.poolCoinDecimal,r=u.poolPcDecimal,a=x.AtoB):(t=t.times(new T(10).pow(u.poolPcDecimal)),m=u.poolPcDecimal,r=u.poolCoinDecimal,a=x.BtoA);let s=[new I(u.amm),new I(u.poolCoinTokenAccount),new I(u.poolPcTokenAccount)];u.oracleMainAccount!==u.oracleSubAccount?(s.push(new I(u.oracleMainAccount)),s.push(new I(u.oracleSubAccount))):s.push(new I(u.oracleMainAccount)),u.oracleSubAccount!==u.oraclePcAccount&&s.push(new I(u.oraclePcAccount));try{let d=yield te(i,s),{amm:f,fees:l,coinBalance:g,pcBalance:y,config:w,oracleMain:p,oracleSub:S,oraclePc:v}=oe(d,u),D=yield i.getSlot(),{amountSwapped:N,priceImpact:Z,fee:O,feePercent:G}=re(t,D,f,l,g,y,w,p,S,v,a),De=new T(c).div(100),ke=new T(Math.floor(N.times(new T(1).minus(De)).toNumber())).div(new T(10).pow(r)).toNumber(),Me=N.div(new T(10).pow(r)).toNumber(),Ke=O.div(new T(10).pow(m)).toNumber();return{amountIn:n,amountOut:Me,amountOutWithSlippage:ke,priceImpact:Z.toNumber(),fee:Ke,feePercent:G.toNumber()}}catch(d){return console.error(d),{amountIn:0,amountOut:0,amountOutWithSlippage:0,priceImpact:0,fee:0,feePercent:0}}}})}function _e(i,n,e,o,c,u,t,a,m=!0){return A(this,null,function*(){try{let r=B(c.toString(),u.toString()),s=new T(e),d=new T(o),f,l,g=new I(r.feeAccount);c.toString()===r.poolCoinMint?(s=s.times(new T(10).pow(r.poolCoinDecimal)),d=d.times(new T(10).pow(r.poolPcDecimal)),f=new I(r.poolCoinTokenAccount),l=new I(r.poolPcTokenAccount)):(s=s.times(new T(10).pow(r.poolPcDecimal)),d=d.times(new T(10).pow(r.poolCoinDecimal)),f=new I(r.poolPcTokenAccount),l=new I(r.poolCoinTokenAccount));let y=$.generate(),w=new I(R()),p=new E(i,y,E.defaultOptions()),S=new X(z,w,p),{approveInstruction:v,swapInstruction:D,signers:N}=yield de(S,r,s,d,n,t,a,f,l,g,m);return{approveInstruction:v,swapInstruction:D,signers:N}}catch(r){return console.warn(r),{approveInstruction:null,swapInstruction:null,signers:[]}}})}function He(i,n,e,o,c,u,t,a,m){return A(this,null,function*(){let r=B(c.toString(),u.toString()),s=$.generate(),d=new I(R()),f=new E(i,s,E.defaultOptions()),l=new X(z,d,f);return yield we(l,e,o,n,t,a,c,r,m)})}function Je(i,n,e,o,c,u){return A(this,null,function*(){let t=B(o.toString(),c.toString());if(t){let a=new T(n),m=new T(e),r=yield Se(i,a,m,t,u);return{coinMaximumIn:r.coinIn,pcMaximumIn:r.pcIn,lpRecive:r.lpRecive}}})}function Qe(i,n,e,o,c,u,t,a,m,r){return A(this,null,function*(){let s=B(u.toString(),t.toString()),d=$.generate(),f=new I(R()),l=new E(i,d,E.defaultOptions()),g=new X(z,f,l);if(s)return yield he(g,s,e,o,c,n,a,m,r)})}function je(i,n,e,o,c){return A(this,null,function*(){let u=B(e.toString(),o.toString());if(u){let t=new T(n),a=yield Te(i,t,u,c);return{lpAmountIn:n,coinMinimumOut:a.coinOut,pcMinimumOut:a.pcOut}}})}function $e(i,n,e,o,c,u,t,a,m,r){return A(this,null,function*(){let s=B(u.toString(),t.toString()),d=$.generate(),f=new I(R()),l=new E(i,d,E.defaultOptions()),g=new X(z,f,l);if(s)return yield ve(g,s,e,o,c,n,a,m,r)})}export{z as IDL,Y as Lifinity,x as TradeDirection,Ze as getAmountOut,re as getCurveAmount,Je as getDepositAmountOut,Qe as getDepositInstruction,te as getMultipleAccounts,oe as getParsedData,B as getPool,Ce as getPoolList,R as getProgramAddress,_e as getSwapInstruction,He as getSwapTransactionWithAuthority,je as getWithdrawAmountOut,$e as getWithdrawInstruction};
